# Noteece — Final Unified Master Plan (v1.0)

## 0) One-liner & North Star

A **local-first**, **end-to-end encrypted**, **Markdown-centric** workspace. **Modes** (View + Template + Automation) sit atop a **single unified data model**. Notes, tasks, projects, and knowledge live in one encrypted vault, offline by default. Sync/sharing are optional and E2E. Zero silos. Zero lock-in. Zero telemetry. Built for speed-of-thought.

---

## 1) Core Principles

* **Local-first & user-owned:** Works offline; optional sync. Files live on disk.
* **E2E encrypted, always:** Keys stay with the user; servers never see plaintext.
* **Unified model:** Modes never fork schema; they’re presentation + workflow on the same objects.
* **Fast & fluid:** Keyboard-first, block editor, sub-second interactions.
* **No lock-in:** Plain Markdown export with full metadata/attachments.
* **Accessibility & i18n from day one:** Full keyboard nav, screen readers, Unicode/CJK/RTL, locale-aware dates/times.
* **Progressive complexity:** Add specialized workflows via a curated **Mode Store**.

---

## 2) Platform, Stack & Vault Layout

### 2.1 Stack

* **Desktop:** Tauri (Rust core + React/TypeScript UI)
* **Mobile:** React Native (iOS/Android) + shared Rust core via UniFFI
* **Core (Rust):** storage, crypto, search, CRDT, background jobs, automations
* **Editor:** Lexical (block plugins) with **strict Markdown round-trip**
* **DB:** SQLite + **SQLCipher** (WAL on)
* **Search:** SQLite **FTS5** inside SQLCipher (encrypted), tokenizer `unicode61 remove_diacritics=2`, optional stemming
* **Rendering:** KaTeX (math), Mermaid (diagrams), Shiki (desktop) / HLJS (mobile) for code
* **Attachments:** Content-addressed blobs (SHA-256), per-blob **AEAD**, **4 KB chunking**; quick annotate (arrow/box/blur)
* **Optional packs:** OCR & SRS as downloadable, **signed** modules (desktop WASM/native; mobile native)
* **IPC:** Tauri commands (desktop), native bridges (mobile)

### 2.2 Vault on disk (per vault)

```
MyVault.noteece/
  vault.sqlite3                # SQLCipher DB (notes, tasks, projects, metadata, FTS)
  objects/                     # encrypted, content-addressed blobs (SHA-256; 4KB chunks)
    ab/abcdef...
  backups/
    2025-11-02T10-00.noteecebk # rotating, E2E-encrypted zip snapshots
  config.json                  # non-sensitive prefs (theme); never secrets
  .locks/                      # import/export/backup locks
```

---

## 3) Crypto & Key Management

* **Master Key (MK):** Argon2id from user passphrase.
* **Data Encryption Key (DEK):** Random 256-bit; encrypts DB + blobs; stored wrapped by MK (AES-KW or XChaCha20-Poly1305).
* **Recovery codes (mandatory):** Recovery Key (RK) with N single-use base32 codes. A DEK copy is wrapped by RK; using a code reconstructs RK and burns that code. UX states clearly: **lose passphrase + codes = irrevocable loss**.
* **Biometrics:** OS keychain holds an MK-wrapped DEK handle; biometrics only unlock that handle.
* **Per-blob keys:** `HKDF(MK, blob_hash)`, unique nonces, dedup via content addressing.
* **Transport (sync):** Only ciphertext + CRDT deltas leave device. No plaintext indexes. No server-side keys.
* **Threat posture:** If a device is compromised **after** unlock, assume exposure. At rest + in transit: AEAD everywhere.

---

## 4) Unified Data Model (relational, mode-friendly)

**ULIDs for all IDs.** Minimal core with rich join tables.

### 4.1 Core tables

```sql
CREATE TABLE space(
  id TEXT PRIMARY KEY, name TEXT NOT NULL, icon TEXT,
  enabled_modes_json TEXT NOT NULL DEFAULT '[]'
);

CREATE TABLE note(
  id TEXT PRIMARY KEY, space_id TEXT NOT NULL REFERENCES space(id),
  title TEXT NOT NULL DEFAULT '', content_md TEXT NOT NULL,
  created_at INTEGER NOT NULL, modified_at INTEGER NOT NULL,
  is_trashed INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE task(
  id TEXT PRIMARY KEY, space_id TEXT NOT NULL REFERENCES space(id),
  note_id TEXT REFERENCES note(id), project_id TEXT REFERENCES project(id),
  parent_task_id TEXT REFERENCES task(id),
  title TEXT NOT NULL,
  status TEXT NOT NULL CHECK(status IN('inbox','next','in_progress','waiting','done','cancelled')),
  due_at INTEGER, start_at INTEGER, completed_at INTEGER,
  priority INTEGER CHECK(priority BETWEEN 1 AND 4),
  estimate_minutes INTEGER, recur_rule TEXT,
  context TEXT, area TEXT
);

CREATE TABLE task_recur_exdate(
  task_id TEXT REFERENCES task(id), exdate INTEGER NOT NULL,
  PRIMARY KEY(task_id, exdate)
);

CREATE TABLE project(
  id TEXT PRIMARY KEY, space_id TEXT NOT NULL REFERENCES space(id),
  title TEXT NOT NULL, goal_outcome TEXT,
  status TEXT NOT NULL CHECK(status IN('proposed','active','blocked','done','archived')),
  confidence INTEGER, start_at INTEGER, target_end_at INTEGER
);

CREATE TABLE tag(
  id TEXT PRIMARY KEY, space_id TEXT NOT NULL REFERENCES space(id),
  name TEXT NOT NULL, color TEXT, UNIQUE(space_id, name)
);

CREATE TABLE note_tags(note_id TEXT, tag_id TEXT, PRIMARY KEY(note_id, tag_id));
CREATE TABLE task_tags(task_id TEXT, tag_id TEXT, PRIMARY KEY(task_id, tag_id));

CREATE TABLE link(source_note_id TEXT, target_note_id TEXT,
  PRIMARY KEY(source_note_id, target_note_id));

CREATE TABLE note_meta(note_id TEXT, key TEXT, value TEXT,
  PRIMARY KEY(note_id, key));

CREATE TABLE person(
  id TEXT PRIMARY KEY, space_id TEXT,
  name TEXT, email TEXT, org TEXT
);

CREATE TABLE task_people(task_id TEXT, person_id TEXT,
  PRIMARY KEY(task_id, person_id));

CREATE TABLE project_milestone(
  id TEXT PRIMARY KEY, project_id TEXT,
  title TEXT, due_at INTEGER, status TEXT
);

CREATE TABLE project_dependency(
  project_id TEXT, depends_on_project_id TEXT,
  PRIMARY KEY(project_id, depends_on_project_id)
);

CREATE TABLE project_risk(
  id TEXT PRIMARY KEY, project_id TEXT,
  description TEXT, impact TEXT, likelihood TEXT, mitigation TEXT,
  owner_person_id TEXT
);

CREATE TABLE project_update(
  id TEXT PRIMARY KEY, project_id TEXT,
  when_at INTEGER, health TEXT, summary TEXT
);

CREATE TABLE saved_search(
  id TEXT PRIMARY KEY, space_id TEXT REFERENCES space(id),
  title TEXT NOT NULL, query_string TEXT NOT NULL,
  scope TEXT NOT NULL CHECK(scope IN('note','project','space','vault_all'))
);
```

### 4.2 Encrypted FTS

```sql
CREATE VIRTUAL TABLE fts_note USING fts5(
  title, content, note_id UNINDEXED,
  tokenize='unicode61 remove_diacritics 2'
);
/* triggers keep fts_note in sync with note */
```

### 4.3 Indexes

* `CREATE INDEX task_due   ON task(due_at)   WHERE status IN('inbox','next','in_progress','waiting');`
* `CREATE INDEX task_start ON task(start_at);`
* `CREATE INDEX note_mod   ON note(modified_at DESC);`
* `CREATE INDEX meta_kv    ON note_meta(key, value);`

---

## 5) Editor Architecture & UX

* **Blocks with stable IDs:** Hidden `^ULID` per block → deep links `[[Title#^blockid]]`.
* **Drag & drop:** Reorder paragraph/list/heading/code blocks.
* **Rope/piece-table core:** Rust (`ropey`) for large notes; incremental parse; re-render dirty blocks only.
* **Strict round-trip:** Markdown ↔ block tree on save; minimal diffs to stabilize FTS/backlinks.
* **Slash menu:** `/task`, `/table`, `/code`, `/mermaid`, `/latex`, `/template`, `/form`.
* **GFM superset:** tables, footnotes, task lists; KaTeX; Mermaid; syntax-highlighted code.
* **Safe paste:** Web/Office HTML → sanitized Markdown; preserves tables/footnotes.
* **Attachments:** paste/drag; thumbnails; optional compression; inline `![[hash|name.ext]]` with width hints; quick annotate (arrow/box/blur).
* **Mobile ergonomics:** floating Markdown toolbar; swipe indent/outdent; autocomplete for `[[links]]` and `#tags`.
* **Command Palette (⌘/Ctrl+K):** global jump + commands.
* **Global undo:** editor + app ops are transactional and undoable.

**Performance budgets:** desktop cold start < **500 ms**; mobile < **800 ms**; FTS refresh < **50 ms**; smooth 60 fps for a **50k-char** note.

---

## 6) Tasks, GTD & Calendar

* **Core fields:** status, due/start/remind, estimate, priority (1–4), recurrence (RFC 5545 + `EXDATE`), area.
* **Global Task Inbox:** dedicated unassigned view.
* **Start dates matter:** `start_at > now` hides items from Next/Today by default.
* **Contexts & labels:** one primary `@context` + many `#labels` via tags.
* **Subtasks:** `parent_task_id` supports nesting; parent shows progress (e.g., 3/5).
* **Calendar view:** tasks, daily notes, milestones; drag to reschedule; snooze nudges start/due.
* **Time zones:** store UTC; retain wall-clock intent with `TZID`; DST-safe recurrences.
* **Sync:** Phase 1 ICS import/export (read-only import; filtered exports). Phase 4 **CalDAV** 2-way with deterministic conflict rules.
* **Today Board:** Now/Next/Later Kanban; Pomodoro timer writes time log entries.

---

## 7) Linking, Backlinks & Deep Links

* `[[Wikilinks]]` with autocomplete; stub on miss.
* Deep links: `noteece://note/<id>` and `...#^blockid` to open exact block.
* Backlinks panel: explicit links + optional **unlinked mentions** (local only).
* Hover previews: local render of title + first lines.

---

## 8) Search & Smart Lists

* Encrypted FTS; accent-insensitive; optional stemming.
* Scope toggles: this note / this project / this space / all vaults.
* Saved searches drive sidebar smart lists and **automation predicates**.

**Example queries:**
`context:@phone due:this_week p>=2`
`type:meeting tag:#decisions updated:<=30d`
`status:waiting person:"Jane Doe"`

---

## 9) Security, Privacy & Data Integrity

* **Vaults:** multiple (e.g., Personal/Work), lock/unlock per vault.
* **Recovery:** mandatory offline codes; explicit irreversible-loss acknowledgment.
* **Trash:** soft delete 30–90 days (configurable).
* **Version history:** per-note zstd snapshots; diff/restore; block-ID-aware merge.
* **Backups:** rolling encrypted snapshots (hourly×12, daily×7, weekly×4); restore wizard with read-only preview.
* **Export:** per note (MD/HTML/PDF); per space (`.md + metadata.json + attachments/`); full vault `.noteece` (E2E). Re-encrypt exports with a different passphrase.
* **Hygiene:** stealth mode (hides journal titles in search), clipboard auto-clear, screenshot blocking (mobile), local audit trail (last opened/edited).
* **Telemetry:** none by default; optional **local** diagnostics with explicit export.
* **Platform reliability:** signed Windows installer (MSIX + delta updates); Android `WorkManager` + exact alarms; SQLite WAL + cloud-drive guardrails.

---

## 10) Modes & Mode Store

**Mode** = metadata defaults + templates + views + automations. Enabling a mode toggles UI/recipes; **never** changes schema.

**Manifest example**

```json
{
  "id": "meeting-notes",
  "name": "Meeting Notes",
  "category": "Work",
  "installs": {
    "templates": ["meeting-note.md"],
    "views": ["meeting-panel"],
    "automations": ["extract-actions"]
  },
  "metadata_defaults": { "type": "meeting" }
}
```

**Automation example (extract @owner tasks)**

```json
{
  "id": "extract-actions",
  "trigger": { "type": "note.updated", "where": { "meta.type": "meeting" } },
  "actions": [
    {
      "type": "task.create_from_markdown_checklist",
      "selector": "section:Action Items",
      "assignment_pattern": "- [ ] @(?<owner>\\w+) (?<title>.+)"
    }
  ]
}
```

### 10.1 Full Mode Catalog (41)

**Core & Daily:**

1. General Note · 2) Daily Note (auto-create; roll unfinished) · 3) Today Board (Now/Next/Later; Pomodoro logging) · 4) Journal/Diary (prompts; mood; stealth; nightly nudge) · 5) Scratchpad (`expires_at`; auto-archive/delete) · 6) Brain Dump (auto task/noteline parser; auto-archive) · 7) Habit/Ritual Tracker (nudges; streaks)

**Personal & Life:**
8) Health Log · 9) Finance/Expense Log · 10) Travel Plan (packing/check-in surfacing) · 11) Recipe (“Cook Mode” with step timers) · 12) Home/Asset Maintenance (interval → recurring tasks) · 13) CRM/Contact Log (`person_id`, `last_contact_at`; Waiting-For ties)

**Learning & Research:**
14) Lecture Note (offline OCR; `[mm:ss]` audio anchors) · 15) Course Hub (sessions/assignments/resources) · 16) Assignment Tracker (`course_id`, `due_at`, `weight`) · 17) Research Note (claim/evidence; paste URL → metadata; `> Quote` auto-tag) · 18) Reading/Book Note (Kindle clippings; Shelf To-Read/Reading/Finished) · 19) Knowledge Cards/Flashcards (local SRS; daily queue) · 20) Lab Notebook/Experiment Log (immutable run stamps; “Mark Result” snapshot) · 21) Research Interview (timestamp anchors; “Make Card/Action”) · 22) Learning Plan (milestones/resources/tasks; “Next Lesson”; progress% reminders)

**Work, Engineering & Content:**
23) Meeting Notes (agenda/decisions/actions → real tasks) · 24) 1:1 Meeting (cadence; Waiting-For from this person) · 25) Code Snippet/Dev Log (filename detection; copy button) · 26) Design Spec / ADR (decisions → project log; approvals link tasks) · 27) Bug/Issue Report (Steps/Expected/Actual; capture shortcut) · 28) SOP/Runbook (“Run Mode” timers; `run_history` log) · 29) Changelog/Release Notes (generate from done tasks tagged `release:<id>`) · 30) Time/Work Log (timer entries; project roll-up) · 31) Writing Draft/Manuscript (session snapshot; DOCX/LaTeX exports) · 32) Content Calendar (calendar for `publish_at`; “Ready to Publish”) · 33) Form Template (YAML → generate typed notes)

**Project & Strategy:**
34) Project Hub (see §11) · 35) Decision Log (ADR) (merges to project decisions) · 36) Retrospective/Postmortem (auto-pull windowed tasks/events; push actions) · 37) Idea Incubator (ICE scoring; Seed→Validate) · 38) Roadmap & OKRs (KR check-ins; initiatives link to projects) · 39) Goal / North Star (outcome/why/metrics; weekly check-in) · 40) Weekly Review (guided GTD wizard; Fri 16:00 prompt) · 41) Monthly/Quarterly Review (zoom-out planning)

---

## 11) Project Management (Project Hub)

**Entities:** milestones, dependencies, risks (impact/likelihood/mitigation/owner), updates (when/health/summary), decisions.

**Views/Tabs**

* **Overview:** goal, status, next actions, upcoming milestones, latest update, key risks
* **Tasks (Kanban):** Backlog / In Progress / Blocked / Done (maps to task status)
* **Timeline:** simple Gantt (milestones + dated tasks); drag to reschedule
* **Risks:** RAID log or impact×likelihood matrix
* **Docs & Decisions:** linked notes/meetings/specs/ADRs (filterable)

**Automations**

* Overdue milestones appear on Today Board + Weekly Review
* Weekly update prompt **Fri 14:00 Europe/Warsaw** (`health: green|amber|red`)
* “Decision” sections in linked notes append to project decision log

**Templates**

* Software Feature (Design/Implement/Test; scope-creep risk; code review/docs checklist)
* Research Project (Lit Review/Method/Draft; data-quality risk)

**Sharing (post-sync)**

* Per-project roles (Owner/Editor/Reader)
* One-click read-only **Brief** export (Overview + latest update) → PDF/HTML
* Per-space retention policies (e.g., soft-delete 30d; hard-delete 90d)

---

## 12) Automation Engine (Triggers → Conditions → Actions)

Local, declarative, undoable JSON DSL. Sandbox for user scripts (QuickJS/Deno). Rate-limited; audit trail of side effects.

* **Triggers:** `schedule(cron)`, `note.created/updated`, `task.status_changed`, `due_at_proximity`, `paste.url/file`, `calendar.event`
* **Conditions:** saved search, tag/context filters, metadata predicates, JS predicate
* **Actions:** create/update/move note/task, add tag/context, schedule reminder, move Kanban lane, stamp template, export, run script, notify
* **Undo:** every action emits its inverse; **Global Undo** replays inverses atomically

**Example — Midnight rollover (Europe/Warsaw)**

```json
{
  "id":"rollover",
  "trigger":{"type":"schedule","cron":"0 0 * * *","tz":"Europe/Warsaw"},
  "conditions":[{"type":"query","q":"status:inbox OR status:next due<today"}],
  "actions":[{"type":"task.update","set":{"due_at":"today 18:00"}}]
}
```

**Example — Paste URL → enrich Research Note**

```json
{
  "id":"url-scrape",
  "trigger":{"type":"paste.url"},
  "conditions":[{"type":"note.meta","key":"type","eq":"research"}],
  "actions":[
    {"type":"fetch.head"},
    {"type":"note.insert_frontmatter","fields":["title","site_name","author"]}
  ]
}
```

---

## 13) Calendar & Time Handling (DST-safe)

* Store timestamps in **UTC**; store `TZID` alongside recurrences/reminders.
* “Every day at 8:00” → `RRULE:FREQ=DAILY;BYHOUR=8;BYMINUTE=0;BYSECOND=0;TZID=Europe/Warsaw`.
* All-day = date ranges without times; rendered as all-day bars.

---

## 14) Import, Export, Backups & Migration

* **Import:** plain Markdown folders; **Obsidian** (links/tags/frontmatter); Notion MD/CSV; Kindle clippings; CSV (tasks/expenses)
* **Export:** per note (MD/HTML/PDF); per space (`.md + metadata.json + attachments/`); full vault `.noteece` (encrypted, re-encryptable)
* **Backups:** rolling encrypted snapshots (hourly×12, daily×7, weekly×4) + restore wizard with preview
* **Version history:** per-note zstd snapshots; block-aware restore to minimize merge pain
* **Schema migration:** versioned migrations with forward/backward tests; `schema_version` table

---

## 15) Onboarding & First-Run (first 5 minutes)

1. **Welcome:** plain-language statement of Local-First + E2E.
2. **Vault creation:** pick folder; emphasize “just files on disk”; open existing vault option.
3. **Encryption setup:** create passphrase; **mandate saving recovery codes**; explicit acknowledgment of data-loss risk.
4. **First Space:** e.g., “Personal”; **Core pack preinstalled** (General Note, Daily Note, Today Board).
5. **Guided tutorial:** create a note → type `- [ ]` to create a task → see it on Today Board → `[[link]]` another note (hover preview) → open Command Palette.
6. **Mode Store card:** discover journals, project hubs, research notes later.

---

## 16) Sync & CRDT (Phase 3+)

* **Notes:** per-block CRDT using **Yrs** (Yjs Rust). Granularity = paragraph/list/code block (reuses stable block IDs).
* **Tasks/Projects:** LWW with deterministic ties:

  * Presence of `completed_at` wins for status
  * Tie-breakers compare `(updated_at, device_ulid)`
* **Attachments:** content-addressed; resumable upload; referenced by hash
* **Transport:** encrypted delta logs (Y updates) + record patches; server = stateless mailbox + object store (ciphertext only)
* **Offline-first:** vector clocks; resolve on reconnect; UI shows “Resolved” pill with diff

---

## 17) Performance, Reliability, Accessibility, Theming

* **Cold start:** desktop < 500 ms; mobile < 800 ms
* **Edit→index:** FTS refresh < 50 ms (typical)
* **Global search:** gate 1k-note “foo” < 100 ms; **goal** 50k notes < 120 ms
* **Large note:** smooth scroll/jump for 50k chars
* **Reminders:** ±2 min under Android Doze; exact alarms when permitted; fallback “nag later”
* **A11y:** full keyboard nav; ARIA roles; high-contrast themes; scalable fonts; labeled controls
* **i18n:** ICU dates; Unicode-safe search; proper CJK line wrap; RTL rendering
* **Theming:** light/dark/system; tight palettes; code-font fallbacks

---

## 18) Settings & Configuration

* **App:** theme, font size, language, keybindings, update channel
* **Vault:** switch/add/open; lock/change passphrase; **manage recovery codes**; backup schedule
* **Space:** name/icon; **Mode Store**; project archive; templates manager
* **Editor:** parser prefs; spellcheck language; default code block language; tab-to-indent
* **Privacy/Hygiene:** stealth mode; clipboard auto-clear; screenshot blocking; local audit trail

---

## 19) Developer Experience & Repo Layout

**Monorepo (turborepo/workspaces)**

```
/apps
  /desktop      # Tauri + React
  /mobile       # React Native + native bridges
/packages
  /core-rs      # Rust: storage, crypto, search, CRDT, jobs, automations
  /editor       # Lexical plugins + Markdown serializer
  /ui           # shared TS components
  /modes        # curated manifests + templates
  /automation-dsl # JSON schema + validator
  /locale       # i18n resources
```

* **CI:** GitHub Actions — Rust clippy/fmt/tests; TS typecheck; Playwright (desktop); Detox (mobile)
* **Repro builds:** deterministic; signed installers (MSIX/DMG)
* **Feature flags:** compile-time gates for OCR/SRS packs

---

## 20) Testing Strategy & Acceptance Gates

* **Unit:** parser; safe-paste; recurrence engine; CRDT merge; crypto KATs; automation actions/undo
* **Property tests:** Markdown round-trip; block-ID stability; automation **reversibility**
* **Fuzzing:** paste sanitizer; Markdown parser inputs
* **Integration:** DB migrations; FTS triggers; import/export parity (Obsidian/Notion)
* **E2E:** vault lifecycle; notes→tasks; backup/restore; export/import; reminders across platforms
* **Performance harness:** large-vault generator (e.g., 50k notes, 300 MB attachments) with repeatable timings

**Gates**

* **P0:** cold start < 500 ms; 1k-note search “foo” < 100 ms; 100-step undo/redo no leaks; recovery codes flow solid
* **P1:** recurrence + `EXDATE`; ICS import idempotent; Mode Store install/uninstall leaves no orphans
* **P3:** CRDT causality suite; three-way conflict resolution per spec

---

## 21) Rollout (phased)

| Phase | Window | Focus                  | Features                                                                                                                                                                                                                                        | Modes                                                       | Exit criteria                                                              |
| ----: | :----: | :--------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------- | :------------------------------------------------------------------------- |
| **0** |  M0–M2 | Minimum Lovable Editor | Rust core (encrypted SQLite, blob store, backups, trash, version history); Editor (blocks+IDs, slash menu, safe paste, attachments, KaTeX, Mermaid); GTD core (start/due, priority, subtasks); Encrypted FTS; Command Palette; A11y/i18n basics | General Note, Daily Note, Today Board, Scratchpad           | Perf gates met; recovery codes enforced; Markdown import; per-note restore |
| **1** |  M3–M5 | Connected Workspace    | Mode Store v1; Project Hub v1 (Overview, Kanban); Calendar view; ICS import/export; Saved searches; Weekly Review; Meeting Notes auto-extract                                                                                                   | + Weekly Review, Meeting Notes, Project Hub                 | Smart lists; overdue surfacing; clean mode enable/disable                  |
| **2** |  M6–M8 | Power User             | Local SRS; OCR pack; Advanced import (Obsidian, Notion); Advanced search (field filters, stemming toggle)                                                                                                                                       | + Research/Reading/Writing/ADR/Code Snippet/Knowledge Cards | OCR on pasted images; SRS daily queue; per-space export round-trips        |
| **3** | M9–M12 | Teams & Sync           | Per-block CRDT; encrypted delta sync v1; Roles & invites; Project Hub Timeline/Risks/Dependencies; read-only Brief export                                                                                                                       | + Team/Project/CRM modes                                    | Sync consistency green; conflict UIs; device add/remove OK                 |
| **4** |  M13+  | Life OS                | Form Templates; local analytics; CalDAV 2-way; remaining personal modes                                                                                                                                                                         | + Health/Finance/Recipe/Travel                              | Community mode API stable; no perf regressions                             |

---

## 22) Monetization & Policy

* **Local app:** free and fully featured; no ads; no data harvesting.
* **Revenue:** optional paid **E2E Sync & Sharing** (flat monthly per user; generous device count).
* **Privacy (sync on):** store only ciphertext, device ULIDs, byte counts. Never content or keys.
* **Export guarantee:** one-click plain-text export of a space; attachments + metadata included.

---

## 23) Open Decisions → Final Calls

1. **CRDT granularity:** **Per-block** (paragraph/list/code). **Chosen.**
2. **OCR/SRS delivery:** **Optional downloads** (keep core lean; signed packs with checksums). **Chosen.**
3. **Scope guard:** Health/Finance/Travel deferred to **Phase 4**; ship PM/Research/Engineering first. **Chosen.**
4. **Key recovery:** Launch with **offline codes** (RK-wrapped DEK). Consider optional Shamir 3-of-5 in Phase 3 if demand + UX justify. **Chosen for later.**

---

## 24) Risk Matrix (with mitigations)

* **Lexical ↔ Markdown drift:** golden round-trip fixtures; property tests; diff visualizer
* **Android exact alarms:** degrade to windowed reminders + polite nag; visible status badge
* **SQLCipher × FTS5 quirks:** pinned versions; CI across Win/macOS/Linux
* **CRDT complexity:** notes in CRDT v1; tasks/projects LWW; crisp conflict UI
* **Mode bloat:** curated Mode Store; Core defaults only; telemetry-free, allow local perf metrics

---

## 25) Cut Rules (if schedule slips)

* Never cut **encryption**, **backups**, or **recovery codes**.
* If needed: defer Mermaid/KaTeX; ship Markdown + tasks first.
* If needed: desktop first; mobile moves to Phase 1.
* If needed: ship ICS import/export before calendar drag/snooze.

---

## 26) Phase-0 “Done” (acceptance)

* Create vault, set passphrase, **store recovery codes** (acknowledged)
* Type a 10k-word note with images — no lag
* Create tasks with start/due; Today Board shows correct set; start-date gating works
* Global search across **1k notes** < 120 ms (**gate**) and scales to **50k** at < 120 ms (**goal**)
* Trash + restore works; per-note version restore works
* Export a space (`.md + metadata.json + attachments/`), re-import to a fresh vault with links/backlinks intact

---

## 27) Examples (queries, templates, automations)

**Saved searches**

* `context:@phone due:this_week p>=2`
* `type:meeting tag:#decisions updated:<=30d`
* `status:waiting person:"Jane Doe"`

**Daily Note template**

```markdown
---
type: daily
date: 2025-11-02
mood:
---

## Agenda
- [ ]

## Notes

## Gratitude
-
```

**Research Note template**

```markdown
---
type: research
source_url:
---

## Claim
## Evidence
> Quote:
## Notes
```

**Automation — Midnight rollover (Europe/Warsaw)**

```json
{
  "id":"rollover",
  "trigger":{"type":"schedule","cron":"0 0 * * *","tz":"Europe/Warsaw"},
  "conditions":[{"type":"query","q":"status:inbox OR status:next due<today"}],
  "actions":[{"type":"task.update","set":{"due_at":"today 18:00"}}]
}
```

**Automation — Paste URL → enrich Research Note**

```json
{
  "id":"url-scrape",
  "trigger":{"type":"paste.url"},
  "conditions":[{"type":"note.meta","key":"type","eq":"research"}],
  "actions":[
    {"type":"fetch.head"},
    {"type":"note.insert_frontmatter","fields":["title","site_name","author"]}
  ]
}
```

---

## 28) Engineering Cadence (lean team)

* **Team:** 1 Rust (core/storage/crypto/search), 1 full-stack (Tauri/React + RN bridges), 1 frontend (editor), 0.5 designer, 0.5 QA/automation
* **Process:** 2-week sprints; monthly hard demo; performance gate each release

**Phase-0 seed tickets**

* DB schema v1 + migrations
* Vault creation + lock/unlock + recovery codes UI
* Encrypted blob store + thumbnails + quick annotate
* Editor MVP (blocks, IDs, slash menu, safe paste)
* Task model + Today Board MVP
* FTS triggers + scoped search + command palette
* Backups/restore wizard + per-note version history
* A11y/i18n base + large-vault perf harness

---

## 29) Step-by-Step Implementation Plan (from zero to Phase-0 ship)

**Step 1 — Monorepo & CI (Week 1)**

* Initialize turborepo workspaces; code owners; lint/format hooks.
* CI for Rust (clippy/fmt/tests) and TS (typecheck); Playwright/Detox scaffolds.

**Step 2 — Storage & Crypto Foundations (Weeks 1–2)**

* SQLCipher bootstrap; schema v1 migrations; WAL tuned.
* Key derivation (Argon2id), DEK wrapping (AES-KW/XChaCha20-Poly1305).
* Recovery code generation, print/save/verify flows.

**Step 3 — Blob Store & Attachments (Week 2)**

* Content-addressed layout, 4 KB chunking, per-blob AEAD via HKDF.
* Thumbnails + quick annotate; integrity checks.

**Step 4 — Editor MVP (Weeks 2–3)**

* Lexical with block IDs; Markdown round-trip; ropey backing store.
* Slash menu basics; safe paste; KaTeX/Mermaid; Shiki/HLJS.

**Step 5 — Tasks & Today Board (Week 3)**

* Task CRUD; subtasks; statuses; start/due; priority.
* Today Board (Now/Next/Later); Pomodoro timer stub.

**Step 6 — Search & Backlinks (Week 3–4)**

* FTS5 inside SQLCipher; triggers; accent-insensitive search.
* Wikilinks; backlinks; hover previews.

**Step 7 — Backups/Trash/Versioning (Week 4)**

* Rolling encrypted snapshots; trash/restore; per-note zstd snapshots.

**Step 8 — Onboarding & A11y/i18n (Week 4)**

* First-run vault creation; recovery codes mandatory flow.
* Keyboard navigation, ARIA labels; ICU dates; RTL/CJK support.

**Step 9 — Calendar View (Phase-0 scope) (Week 5)**

* Local calendar rendering for tasks/daily notes; ICS import (read-only) + export.

**Step 10 — Mode Store v0 (Week 5)**

* Preinstalled Core pack; light installer to toggle modes (no external network required).

**Step 11 — Perf Harness & P0 Gates (Week 6)**

* Large-vault generator; 50k-note search; 100-step undo; cold start timing.
* Fix leaks, regressions; document acceptance evidence.

**Step 12 — Phase-0 Release Prep (Week 6)**

* Signed MSIX/DMG; update channel; crash-safe guardrails.
* Docs: export guarantees; restore wizard guide.

*(Subsequent steps track Phase 1–4 roadmap in §21.)*

---

## 30) Immediate Next Step

Stand up the monorepo, land Phase-0 schema + vault flows behind a feature flag, wire the editor skeleton, and run the large-vault perf harness to validate block IDs, FTS triggers, and a 100-step undo stack under load.

---